---
title: "Data Import and Cleaning"
author: "Lyuou Zhang"
date: "3/27/2019"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(rnoaa)
library(rvest)
library(httr)
library(jsonlite)
library(lubridate)
library(ggridges)
library(sf)
```

## NOAA data

### Step 1. pull NOAA data from its API

I pulled all the stations in NY and used their IDs to pull all the data at these stations. `stations` is the dataset with all NY stations. `nydat` is the dataset that has the NY weather data

```{r eval = FALSE}
nystationids <- ghcnd_stations() %>% 
  filter(state == "NY") %>% 
  distinct(id)

# Pull the desired weather data for all of these stations
nydat <- meteo_pull_monitors(nystationids$id, 
                             date_min = "2007-01-01", 
                             date_max = "2017-12-31", 
                             var = c("PRCP", "SNOW", "SNWD", "TMAX", "TMIN"))
```

Note that this dataset does not have the county names. To find the county for each station, we used the latitude and longitude of each station and spatially join with the NYS county shapefile in GIS to get the county names.

```{r eval = FALSE}
ny_county <- stations %>% 
  filter(state == "NY") %>% 
  dplyr::select(id:name, -state) %>% 
  .[!duplicated(.[c('id', 'latitude', 'longitude', 'elevation', 'name')]),]

```

Some work behind the scene in QGIS...

After we figured out the county of each weather station, joined that back to the NOAA data in `nydat`

```{r eval = FALSE}
# import the ny county file joined with the county names from QGIS
ny_county_name <- read_csv('./data/ny_county_name.csv') %>% 
  janitor::clean_names() %>% 
  dplyr::select(-field_1) %>% 
  rename(county = name_1)
 

# join with nydata, and convert the temperature to degree celsius.
nydata <- nydat %>% 
  mutate(
    date = ymd(date)
  ) %>% 
  left_join(., ny_county_name, by = 'id') %>% 
  mutate(
    tmax = tmax/10,
    tmin = tmin/10
  )
 
```

Yayyy! So the final NOAA data will be `nydata`. Be sure to **remove all the `NA` values** before you use it.

## Birth data

This one is a lot easier.

```{r}
births <- read_delim('./data/NYS_0717_groupby_CYM_OEGestWeekly.txt', delim = '\t') %>% 
  janitor::clean_names() %>% 
  filter(is.na(notes)) %>% 
  filter(county_code != '36999') %>% 
  select(-notes)

```









